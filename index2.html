<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Continuous Vertical Marquee — Fixed Heading + Column Alignment</title>
  <style>
    html,body{
      height:100%;width:100%;
      margin:0;padding:0;
      overflow:hidden;
      font-family:system-ui,Segoe UI,Roboto,Arial;
      background:#0b1220;color:#fff;
    }
    .wrap{height:100%;width:100%;display:flex;flex-direction:column}
    .card{height:100%;width:100%;display:flex;flex-direction:column}

    /* grid-based header */
    .heading-bar{
      flex:0 0 auto;
      padding:10px 16px;
      background:#1e293b;
      border-bottom:2px solid #334155;
      display:grid;
      gap:12px;
      font-weight:700;
      font-size:16px;
      color:#e2e8f0;
      position:sticky;
      top:0;
      z-index:10;
    }

    /* viewport for marquee */
    .marquee-viewport{
      flex:1;
      height:100%;
      overflow:hidden;
      position:relative;
      padding:10px 16px;
      box-sizing:border-box;
    }

    .marquee-track{
      display:flex;
      flex-direction:column;
      gap:8px;
      width:100%;
      --scroll-distance: 0px;
      animation-name: marqueeScroll;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
      animation-play-state: paused;
    }
    @keyframes marqueeScroll {
      from { transform: translateY(0); }
      to   { transform: translateY(calc(-1 * var(--scroll-distance))); }
    }

    /* each row matches grid of header */
    .marquee-row{
      display:grid;
      gap:12px;
      align-items:center;
      background: rgba(255,255,255,0.03);
      padding:10px 16px;
      border-radius:6px;
      font-size:15px;
      line-height:1.3;
      min-height:40px;
      box-sizing:border-box;
    }

    .row-image{max-width:40px;max-height:40px;border-radius:6px}

    .controls{
      position:fixed;
      left:12px;
      right:12px;
      bottom:12px;
      display:flex;
      gap:8px;
      align-items:center;
      padding:8px;
      background:rgba(0,0,0,0.35);
      border-radius:8px;
      z-index:50;
      backdrop-filter: blur(6px);
    }
    button,select{
      padding:6px 10px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(255,255,255,0.05);
      color:#fff;
      cursor:pointer;
    }
    .small{font-size:13px;color:#cbd5e1}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- Fixed heading bar -->
      <div class="heading-bar" id="headingBar">Loading headers…</div>

      <!-- Scrolling content -->
      <div class="marquee-viewport" id="marqueeViewport">
        <div class="marquee-track" id="marqueeTrack">
          <div class="marquee-row"><div>Loading…</div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="controls" style="display: none;">
    <div class="small" id="status">Waiting…</div>
    <button id="reloadBtn">Reload</button>
    <button id="pauseBtn">Pause</button>
    <label class="small">Speed:
      <select id="speedSelect">
        <option value="30">fast</option>
        <option value="50" selected>normal</option>
        <option value="80">slow</option>
      </select>
    </label>
  </div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyvoV0DgsdXNHdsdQOSDqGLe2uER2Q59kUrHS2eI63Dh8CNCDDoVyJ1-uqtfmmXE1YV/exec";

const marqueeTrack = document.getElementById('marqueeTrack');
const headingBar = document.getElementById('headingBar');
const statusEl = document.getElementById('status');
const reloadBtn = document.getElementById('reloadBtn');
const pauseBtn = document.getElementById('pauseBtn');
const speedSelect = document.getElementById('speedSelect');

let rowsData = [];
let headers = [];
let isPaused = false;
let SPEED_PX_PER_SEC = Number(speedSelect.value) || 50;

function loadJSONP(url){
  return new Promise((resolve, reject) => {
    const cbName = 'gs_cb_' + Math.random().toString(36).slice(2);
    window[cbName] = function(data){
      resolve(data);
      try { delete window[cbName]; } catch(e){ window[cbName] = null; }
      const s = document.getElementById(cbName);
      if (s) s.remove();
    };
    const script = document.createElement('script');
    script.id = cbName;
    script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cbName;
    script.onerror = () => { reject(new Error('JSONP load failed')); if(window[cbName]) delete window[cbName]; script.remove(); };
    document.body.appendChild(script);
  });
}
function isImageUrl(url){ return !!(url && typeof url==="string" && url.toLowerCase().match(/\.(png|jpe?g|gif|webp|svg)(\?|#|$)/)); }

function makeRowElement(rowObj){
  const el = document.createElement('div');
  el.className = 'marquee-row';
  el.style.gridTemplateColumns = `repeat(${headers.length}, 1fr)`;

  headers.forEach(h=>{
    const val = rowObj[h] != null ? String(rowObj[h]) : '';
    const cell = document.createElement('div');
    if(isImageUrl(val)){
      const img=document.createElement('img');
      img.src=val; img.className='row-image'; img.alt=h;
      img.onerror=()=>{cell.textContent=val;};
      cell.appendChild(img);
    } else {
      cell.textContent=val;
    }
    el.appendChild(cell);
  });
  return el;
}

function renderRows(data){
  marqueeTrack.innerHTML='';
  if(!data.length){ marqueeTrack.innerHTML='<div class="marquee-row">No data</div>'; return; }
  data.forEach(r=> marqueeTrack.appendChild(makeRowElement(r)));
}

function prepareSeamlessLoop(){
  const children=[...marqueeTrack.children];
  if(!children.length) return;
  const originalHeight=marqueeTrack.scrollHeight;
  children.forEach(n=> marqueeTrack.appendChild(n.cloneNode(true)));
  marqueeTrack.style.setProperty('--scroll-distance', originalHeight+'px');
  const duration=Math.max(70, Math.round(originalHeight/SPEED_PX_PER_SEC));
  marqueeTrack.style.animationDuration=duration+'s';
  marqueeTrack.style.animationPlayState=isPaused?'paused':'running';
}

async function loadAndStart(){
  try{
    statusEl.textContent='Loading…'; marqueeTrack.style.animationPlayState='paused';
    const data=await loadJSONP(WEB_APP_URL);
    if(!data||!data.length){ statusEl.textContent='No data'; renderRows([]); return; }
    rowsData=data.slice();
    headers=Object.keys(rowsData[0]);
    // build heading
    headingBar.innerHTML='';
    headingBar.style.gridTemplateColumns=`repeat(${headers.length}, 1fr)`;
    headers.forEach(h=>{
      const span=document.createElement('div');
      span.textContent=h;
      headingBar.appendChild(span);
    });
    renderRows(rowsData);
    setTimeout(()=>prepareSeamlessLoop(),160);
  }catch(e){ console.error(e); statusEl.textContent='Error loading data'; }
}

reloadBtn.onclick=()=>loadAndStart();
pauseBtn.onclick=()=>{isPaused=!isPaused; marqueeTrack.style.animationPlayState=isPaused?'paused':'running'; pauseBtn.textContent=isPaused?'Resume':'Pause';};
speedSelect.onchange=()=>{SPEED_PX_PER_SEC=Number(speedSelect.value)||50; if(rowsData.length){renderRows(rowsData); setTimeout(()=>prepareSeamlessLoop(),120);}};

if(WEB_APP_URL.includes('REPLACE_WITH_YOURS')){ statusEl.textContent='Replace WEB_APP_URL'; }
else{ loadAndStart(); }
</script>
</body>
</html>
